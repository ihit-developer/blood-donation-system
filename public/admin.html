<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<!-- HIDDEN FORM FOR CONFIRM ACTIONS -->
<form id="actionForm" method="POST" style="display:none;"></form>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark shadow"
     style="background: linear-gradient(90deg, #b71c1c, #7f0000);">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">ü©∏ Blood Donation System</a>

    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-auto gap-lg-2">
        <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
        
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Donor</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="donor-register.html">Register</a></li>
            <li><a class="dropdown-item" href="donor-login.html">Login</a></li>
          </ul>
        </li>

        <li class="nav-item"><a class="nav-link" href="request-blood.html">Request Blood</a></li>
        <li class="nav-item"><a class="nav-link" href="request-status.html">Request Status</a></li>
        <li class="nav-item"><a class="nav-link" href="request-history.html">Request History</a></li>

        <li class="nav-item">
          <a class="btn btn-light btn-sm text-danger fw-bold ms-lg-2"
             href="admin-login.html">Admin</a>
             <li class="nav-item">
  <a href="/admin/logout"
     class="btn btn-outline-light btn-sm fw-bold ms-lg-2 mt-2 mt-lg-0">
    Logout
  </a>
</li>
<li class="nav-item dropdown position-relative">
  <a class="nav-link position-relative notification-bell"
     href="#"
     data-bs-toggle="dropdown"
     aria-expanded="false">

    üîî
    <span id="notificationCount"
          class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle">
      0
    </span>
  </a>

  <ul class="dropdown-menu dropdown-menu-end shadow notification-dropdown">
    <li class="dropdown-header fw-bold text-danger">
      Notifications
    </li>

    <div id="notificationList">
      <li class="dropdown-item text-muted text-center">
        No notifications
      </li>
    </div>
  </ul>
</li>



        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-5">

<!-- ================= DONORS ================= -->
<h4 class="text-danger mb-3">Registered Donors</h4>

<table class="table table-bordered table-striped">
  <thead class="table-danger">
  <tr>
    <th>Name</th>
    <th>Age</th>
    <th>Blood</th>
    <th>Contact</th>
    <th>City</th>
    <th>Action</th>
  </tr>
</thead>
  <tbody id="donorTable"></tbody>
</table>

<script>
fetch("/donors")
.then(res => res.json())
.then(data => {
  let rows = "";
  data.forEach(d => {
    rows += `
  <tr>
    <td>${d.name}</td>
    <td>${d.age}</td>
    <td>${d.bloodGroup}</td>
    <td>${d.contact}</td>
    <td>${d.city}</td>
    <td>
          <button class="btn btn-warning btn-sm"
            onclick="editDonor('${d._id}','${d.name}','${d.age}','${d.bloodGroup}','${d.contact}','${d.city}')">
            Edit
          </button>

          <button class="btn btn-danger btn-sm"
            onclick="confirmAction('/donors/delete/${d._id}')">
            Delete
          </button>
        </td>
      </tr>
    `;
  });
  donorTable.innerHTML = rows;
});
</script>

<!-- ================= EDIT DONOR MODAL ================= -->
<div class="modal fade" id="editDonorModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editDonorForm" method="POST">

        <div class="modal-header bg-warning">
          <h5 class="modal-title">Edit Donor</h5>
        </div>

        <div class="modal-body">
          <input id="editName" name="name" class="form-control mb-2" placeholder="Name" required>
          <input id="editAge" name="age" class="form-control mb-2" placeholder="Age" required>
          <input id="editBlood" name="bloodGroup" class="form-control mb-2" placeholder="Blood Group" required>
          <input id="editContact" name="contact" class="form-control mb-2" placeholder="Contact" required>
          <input id="editCity" name="city" class="form-control mb-2" placeholder="City" required>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Update</button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
function editDonor(id, name, age, blood, contact, city) {
  editName.value = name;
  editAge.value = age;
  editBlood.value = blood;
  editContact.value = contact;
  editCity.value = city;

  document.getElementById("editDonorForm").action = `/donors/update/${id}`;
  new bootstrap.Modal(document.getElementById("editDonorModal")).show();
}
</script>

<!-- ================= REQUESTS ================= -->
<h4 class="text-danger mt-5">Blood Requests</h4>

<table class="table table-bordered">
  <thead class="table-danger">
  <tr>
    <th>Patient</th>
    <th>Age</th>
    <th>Blood</th>
    <th>City</th>
    <th>Status</th>
    <th>Action</th>
  </tr>
</thead>

  <tbody id="requests"></tbody>
</table>

<script>
fetch("/requests")
.then(res => res.json())
.then(data => {
  let rows = "";
  data.forEach(r => {
    rows += `
     <tr class="${r.emergency ? 'table-danger' : ''}">
  <td>
    ${r.patientName}
    ${r.emergency ? '<span class="badge bg-danger ms-2">Emergency</span>' : ''}
  </td>
  <td>${r.age ?? "-"}</td>
  <td>${r.bloodGroup}</td>
  <td>${r.city}</td>
  <td>
    <span class="badge ${
      r.status === "Approved" ? "bg-success" :
      r.status === "Rejected" ? "bg-danger" :
      "bg-warning"
    }">${r.status}</span>
  </td>
  <td>
    ${
      r.status === "Pending" ? `
        <button class="btn btn-success btn-sm"
          onclick="confirmAction('/requests/approve/${r._id}')">Accept</button>
        <button class="btn btn-danger btn-sm"
          onclick="confirmAction('/requests/reject/${r._id}')">Reject</button>
      ` : ""
    }
    <button class="btn btn-dark btn-sm"
      onclick="confirmAction('/requests/delete/${r._id}')">Delete</button>
  </td>
</tr>

    `;
  });
  requests.innerHTML = rows;
});
</script>

<!-- ================= SEARCH DONORS ================= -->
<h4 class="text-danger mt-4">Search Donors</h4>

<div class="row mb-3">
  <div class="col-md-4">
    <select id="bloodGroup" class="form-select">
      <option value="">Blood Group</option>
      <option>A+</option><option>A-</option>
      <option>B+</option><option>B-</option>
      <option>AB+</option><option>AB-</option>
      <option>O+</option><option>O-</option>
    </select>
  </div>

  <div class="col-md-4">
    <input list="cityList" id="city" class="form-control" placeholder="City">
    <datalist id="cityList">
      <option value="Lahore">
      <option value="Karachi">
      <option value="Islamabad">
      <option value="Multan">
    </datalist>
  </div>

  <div class="col-md-4">
    <button class="btn btn-danger w-100" onclick="searchDonors()">Search</button>
  </div>
</div>


<table class="table table-bordered">
  <thead class="table-danger">
    <tr>
      <th>Name</th><th>Blood</th><th>City</th><th>Contact</th>
    </tr>
  </thead>
  <tbody id="searchResult"></tbody>
</table>
<!-- ================= STATISTICS ================= -->
<div class="row text-center mt-5">

  <div class="col-md-3">
    <div class="card shadow p-3">
      <h6>Total Donors</h6>
      <h2 id="donorCount">0</h2>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow p-3">
      <h6>Total Requests</h6>
      <h2 id="requestCount">0</h2>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow p-3">
      <h6>Approved</h6>
      <h2 id="approvedCount">0</h2>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow p-3">
      <h6>Rejected</h6>
      <h2 id="rejectedCount">0</h2>
    </div>
  </div>

</div>
<!-- ================= CHART ================= -->
<div class="row mt-4">
  <div class="col-md-6 mx-auto">
    <div class="card shadow p-3">
      <h6 class="text-center text-danger mb-2">
        Blood Request Status Overview
      </h6>
      <div style="height:220px;">
        <canvas id="requestChart"></canvas>
      </div>
    </div>
  </div>
</div>



<script>
function searchDonors() {
  const bg = bloodGroup.value;
  const cityVal = city.value;

  fetch(`/donors/search?bloodGroup=${bg}&city=${cityVal}`)
    .then(res => res.json())
    .then(data => {
      searchResult.innerHTML =
        data.length === 0
          ? `<tr><td colspan="4" class="text-danger text-center">‚ùå No donor found</td></tr>`
          : data.map(d => `
              <tr>
                <td>${d.name}</td>
                <td>${d.bloodGroup}</td>
                <td>${d.city}</td>
                <td>${d.contact}</td>
              </tr>
            `).join("");
    });
}
</script>

<!-- ================= CONFIRM MODAL ================= -->
<div class="modal fade" id="confirmModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirm Action</h5>
      </div>
      <div class="modal-body">Are you sure?</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="submitAction()">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script>
let actionUrl = "";

function confirmAction(url) {
  actionUrl = url;
  new bootstrap.Modal(confirmModal).show();
}

function submitAction() {
  actionForm.action = actionUrl;
  actionForm.submit();
}
</script>
<script>
fetch("/donors/count")
  .then(res => res.json())
  .then(data => {
    donorCount.innerText = data.totalDonors;
  });

fetch("/requests/stats")
  .then(res => res.json())
  .then(data => {
    requestCount.innerText = data.total;
    approvedCount.innerText = data.approved;
    rejectedCount.innerText = data.rejected;
  });
</script>
<script>
fetch("/requests/stats")
  .then(res => res.json())
  .then(data => {

    new Chart(document.getElementById("requestChart"), {
      type: "doughnut",
      data: {
        labels: ["Approved", "Rejected", "Pending"],
        datasets: [{
          data: [
            data.approved,
            data.rejected,
            data.total - data.approved - data.rejected
          ],
          backgroundColor: ["#28a745", "#dc3545", "#ffc107"]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "65%",
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });

  });
</script>
<script>
function loadNotifications() {
  fetch("/notifications")
    .then(res => res.json())
    .then(data => {
      notifList.innerHTML = data.length === 0
        ? `<li class="list-group-item text-center">No notifications</li>`
        : data.map(n =>
            `<li class="list-group-item">${n.message}</li>`
          ).join("");
    });
}

function loadNotificationCount() {
  fetch("/notifications/count")
    .then(res => res.json())
    .then(data => {
      notifBadge.innerText = data.count;
      notifBadge.style.display = data.count > 0 ? "inline-block" : "none";
    });
}

function toggleNotifications() {
  const box = document.getElementById("notificationBox");
  box.style.display = box.style.display === "none" ? "block" : "none";

  fetch("/notifications/read", { method: "POST" })
    .then(() => loadNotificationCount());

  loadNotifications();
}

// AUTO LOAD
loadNotificationCount();
setInterval(loadNotificationCount, 5000);
</script>


</div>
</body>
</html>
